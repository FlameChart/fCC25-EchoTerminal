<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EchoTerminal - automation factory</title>

        <!-- some basic style -->
        <style>
            * {
                margin: 0;
                padding: 0;
                transition: all 0.15s ease-in-out;
            }

            body {
                display: flex;
                flex-wrap: nowarp;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 0.4rem;

                font-family: "IBM Plex Mono", monospace;
                font-weight: normal;
                font-style: normal;

                color: #10fefe;
                background-color: #0e202a;
            }

            .bitcount {
                font-family: "Bitcount Grid Single", sans-serif;
                font-weight: normal;
                font-style: normal;
            }

            .mono {
                font-family: "IBM Plex Mono", monospace;
                font-weight: normal;
                font-style: normal;
            }
        </style>

        <!-- here is some typography style -->
        <style>
            h1 {
                font-size: 2.986rem;
            }

            h2 {
                font-size: 2.488rem;
            }

            h3 {
                font-size: 2.074rem;
            }

            p {
                font-size: 1rem;
            }
        </style>

        <!-- modern component style -->
        <style>
            button {
                border: 0;
                border-radius: 0.618rem;
                padding: 0.5rem 1rem 0.45rem;

                font-size: 1rem;

                color: #10fefe;
                background-color: #064e64;
            }

            button:hover {
                background-color: #0595c4;
            }

            textarea {
                border: 0;
                padding: 0.5rem 0.45rem;

                font-size: 1rem;

                color: #10fefe;
                background-color: #102d3b;

                resize: none;
            }

            textarea:focus {
                outline: none;
            }

            input {
                border: 0;
                padding: 0;

                font-size: 1rem;

                color: #10fefe;
                background-color: transparent;
            }

            input:focus {
                outline: none;
            }
        </style>

        <!-- apply fonts -->
        <style>
            @font-face {
                font-family: "IBM Plex Mono";
                src: url("res/fonts/IBM_Plex_Mono/IBMPlexMono-Regular.ttf")
                    format("truetype");
                font-weight: normal;
                font-style: normal;
            }

            @font-face {
                font-family: "Bitcount Grid Single";
                src: url("res/fonts/Bitcount_Grid_Single/static/BitcountGridSingle-Regular.ttf")
                    format("truetype");
                font-weight: normal;
                font-style: normal;
            }
        </style>
    </head>
    <body>
        <!-- in case i need to use some SVG's -->
        <script>
            function lucide(icon) {
                switch (icon) {
                    case "chevrons-down":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-down-icon lucide-chevrons-down"><path d="m7 6 5 5 5-5"/><path d="m7 13 5 5 5-5"/></svg>';
                    case "chevrons-up":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-up-icon lucide-chevrons-up"><path d="m17 11-5-5-5 5"/><path d="m17 18-5-5-5 5"/></svg>';
                    case "chevrons-left":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-left-icon lucide-chevrons-left"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>';
                    case "chevrons-right":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-right-icon lucide-chevrons-right"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>';
                    case "bot":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>';
                    case "goal":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-goal-icon lucide-goal"><path d="M12 13V2l8 4-8 4"/><path d="M20.561 10.222a9 9 0 1 1-12.55-5.29"/><path d="M8.002 9.997a5 5 0 1 0 8.9 2.02"/></svg>';
                    case "circle-play":
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play-icon lucide-circle-play"><path d="M9 9.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997A1 1 0 0 1 9 14.996z"/><circle cx="12" cy="12" r="10"/></svg>';
                    default:
                        return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 20l-7-7h14l-7 7z"/></svg>';
                }
            }
        </script>

        <!-- Okay so for a better code organizing, I'd like to just put some const here. -->
        <script>
            // here is the define's
            // we need some "object" to contains "What is a level"
            function level(name, id, description, height, width, objects) {
                this.name = name;
                this.id = id;
                this.description = description;
                this.height = height;
                this.width = width;
                this.objects = objects;
            }

            // and here is the "blueprint" of all the game objects
            function gameObjects(
                type,
                symbol = "X",
                x = 0,
                y = 0,
                direction = "down",
                removable = false,
            ) {
                this.type = type;
                this.symbol = symbol;
                this.x = x;
                this.y = y;
                this.direction = direction;
                this.removable = removable;
            }

            function objBelt(x, y, direction) {
                switch (direction) {
                    case "up":
                        return new gameObjects(
                            "belt",
                            lucide("chevrons-up"),
                            x,
                            y,
                            direction,
                        );
                    case "down":
                        return new gameObjects(
                            "belt",
                            lucide("chevrons-down"),
                            x,
                            y,
                            direction,
                        );
                    case "left":
                        return new gameObjects(
                            "belt",
                            lucide("chevrons-left"),
                            x,
                            y,
                            direction,
                        );
                    case "right":
                        return new gameObjects(
                            "belt",
                            lucide("chevrons-right"),
                            x,
                            y,
                            direction,
                        );
                }
            }

            // and here is the level lists
            const levels = [
                new level(
                    "Level 1",
                    "1",
                    "Learn the basics - Moving around",
                    5,
                    5,
                    [
                        new gameObjects("spawn", lucide("circle-play"), 2, 0),
                        new gameObjects("flag", lucide("goal"), 2, 4),
                    ],
                ),
            ];

            // just a backup of currently loading levels, for showing level info
            var loadedLevel = new level();
        </script>
        <h1 class="bitcount">EchoTerminal - automation factory</h1>
        <p style="margin-bottom: 2rem">-- inspired by Manufactoria & ShapeZ</p>
        <div
            id="container"
            style="
                display: flex;
                flex-direction: row;
                gap: 0.6rem;
                justify-content: space-between;
                width: 60vw;
            "
        >
            <div
                id="levelContainer"
                style="
                    display: flex;
                    flex-direction: column;
                    width: 12rem;
                    padding: 0.25rem;
                    align-items: end;
                    gap: 0.25rem;
                "
            ></div>
            <div
                id="gameContainer"
                style="
                    display: flex;
                    flex-direction: column;
                    width: 100%;
                    align-items: center;
                "
            >
                <div
                    id="gameStage"
                    style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        min-height: 30vh;
                    "
                >
                    No level loaded, try to start a level on your left.
                </div>
                <div id="gameEmulatedTerminal">
                    <!-- so here is the core / the only way to interact with the board -->
                    <textarea
                        id="terminalDisplay"
                        class="mono"
                        rows="12"
                        cols="80"
                        readonly
                        resize="none"
                    ></textarea>
                    <br />
                    &gt;
                    <input
                        type="text"
                        id="terminalInput"
                        class="mono"
                        style="width: 40rem"
                        placeholder="Enter commands."
                    />
                </div>
            </div>
        </div>

        <!-- page manipulation goes here -->
        <script>
            // init and display the levels
            document.querySelector("#levelContainer").innerHTML =
                `<h2 class="bitcount">Levels</h2>` +
                levels
                    .map(
                        (level) =>
                            `<div class="level">
                            <button class="play-button" onclick="startLevel('${level.id}')">Load ${level.name}</button>
                            </div>`,
                    )
                    .join("");
        </script>

        <!-- the actual logic goes here -->
        <script>
            function startLevel(id) {
                // flags about is the level loaded or nah
                let flag = false;
                // first we need to have a way to recognize the level's size & basic info
                for (let i = 0; i < levels.length; i++) {
                    // skip the other levels
                    if (levels[i].id !== id) continue;
                    let level = levels[i];
                    loadedLevel = level;
                    flag = true;

                    // generate the table for game field
                    // we need to generate the chess board for the actuall field
                    // and adding some extra border for a easier "failing" detection
                    let table = document.createElement("table");
                    table.id = "gameTable";
                    // table.style.border = '1px solid black';
                    table.style.borderCollapse = "collapse";

                    for (let y = -1; y < levels[i].height + 1; y++) {
                        let row = document.createElement("tr");
                        for (let x = -1; x < levels[i].width + 1; x++) {
                            let cell = document.createElement("td");

                            cell.style.border = "1px solid #044771";
                            cell.style.width = "2rem";
                            cell.style.height = "2rem";

                            if (
                                x === -1 ||
                                y === -1 ||
                                x === level.width ||
                                y === level.height
                            ) {
                                cell.style.border = "0px";
                            }
                            row.appendChild(cell);
                        }
                        table.appendChild(row);
                    }

                    // now we need to put the object into the table
                    for (let i = 0; i < level.objects.length; i++) {
                        let obj = level.objects[i];
                        placeObjects(table, obj, "place");
                    }

                    document.querySelector("#gameStage").innerHTML =
                        level.description;
                    document.querySelector("#gameStage").appendChild(table);
                }
                return flag;
            }

            // standalone place object function
            function placeObjects(table, object, type = "place") {
                let isSuccess = false;
                // okay we should check the pos is empty or nah
                for (let i = 0; i < loadedLevel.objects.length; i++) {
                    if (
                        loadedLevel.objects[i].x === object.x &&
                        loadedLevel.objects[i].y === object.y &&
                        type !== "place"
                    ) {
                        return;
                    }
                }

                // put the obj in table for display first
                let cell =
                    table.rows[Number(object.y) + 1].cells[
                        Number(object.x) + 1
                    ];
                cell.style.textAlign = "center";
                cell.innerHTML = object.symbol;

                // only contains two types of action
                // place(pre-defined in levels) and add(placed by player)
                if (type !== "place") {
                    object.removable = true;
                    cell.style.backgroundColor = "#043d4e";

                    // okay so we need to put the obj into a list for the actually exectuion section
                    // uhh so we need to put the obj into the `loadedLevel.objects`
                    // because that is being set when a level is loaded
                    // and is not edit the original levels
                    // (okay u can just reset by refresh the page so idk if this is necessary...)
                    loadedLevel.objects.push(object);
                    isSuccess = true;
                }
                return isSuccess;
            }

            function runRobot(){
              // so first we need to remember what is the moving bot
              // first we need to lookup the spawn obj to spawn robot on top of it
              // and then bot moving down by default
              // then we detect which obj the bot stands on
              // if there has belt we just moving on the direction
              // if there has nothing the robot dead and the game is failed(okay u can retry)
              // if there has flag then game / level is passed
              // if there has the colorizer then colored the robot and put it towards
              // if there has a one way color wall we can just pass
            }

            // bind the "Submit" to the input
            let terminalInput = document.querySelector("#terminalInput");
            terminalInput.addEventListener("keydown", (event) => {
                let key = event.key;
                if (key === "Enter") {
                    terminalEvent(terminalInput.value);
                    terminalInput.value = "";
                }
            });

            function terminalEvent(input) {
                // let terminal can be access
                var textarea = document.querySelector("#terminalDisplay");

                textarea.value += "\n\n> " + input + "\n";

                const baseCommand = input.split(" ")[0];
                switch (baseCommand) {
                    case "clear":
                        textarea.value = "";
                        break;
                    case "help":
                        const helpAction = input.split(" ")[1];
                        switch (helpAction) {
                            case "level":
                                textarea.value += `Available commands for ${helpAction}:\n`;
                                textarea.value +=
                                    "info - display the current level info\n";
                                textarea.value +=
                                    "load <ID> - load the specific level\n";
                                textarea.value +=
                                    "restart - restart this level\n";
                                break;
                            default:
                                textarea.value += "Available commands:\n";
                                textarea.value +=
                                    "clear - clear the terminal\n";
                                textarea.value +=
                                    "help - display this message\n";
                                textarea.value +=
                                    "level - switch and restart the level\n";
                        }
                        break;
                    case "level":
                        const levelAction = input.split(" ")[1];
                        switch (levelAction) {
                            case "info":
                                if (loadedLevel.id === undefined) {
                                    textarea.value +=
                                        "You are not in any levels.\n";
                                } else {
                                    textarea.value += `You are in ${loadedLevel.name}(${loadedLevel.id}) now.\n`;
                                }
                                break;
                            case "load":
                                const levelID = input.split(" ")[2];
                                if (startLevel(levelID)) {
                                    textarea.value +=
                                        "Level loaded successfully!\n";
                                } else {
                                    textarea.value += `Level ${levelID} is not loaded, is the ID correct?\n`;
                                }
                                break;
                            case "restart":
                                textarea.value += `Restarting...\n`;
                                startLevel(loadedLevel.id);
                                break;
                            default:
                                textarea.value +=
                                    "Unknown level action. Try to use 'help <command>' to get the usage.\n";
                        }
                        break;
                    case "place":
                        const placeAction = input.split(" ")[1];
                        switch (placeAction) {
                            case "belt":
                                // looks bad but understandable and can seperates the actually working part
                                const beltInfo = input.split(" belt ")[1];

                                // so the command is like
                                // `place belt (corrds) (facing)`
                                // so to be place in (2,3) and facing down
                                // its be like `place belt 2 3 [facing is down by default]
                                if (
                                    beltInfo.split(" ").length < 2 ||
                                    beltInfo.split(" ").length > 4
                                ) {
                                    textarea.value += `Argument is invalid. Usage: place belt x y [facing]\n`;
                                    break;
                                }

                                let [x, y, facing] = beltInfo.split(" ");

                                // gaves feedback when the input's format is correct but not valid
                                if (!/^\d+$/g.test(x) || !/^\d+$/g.test(y)) {
                                    textarea.value += `Coordinates must be numbers. Usage: place belt x y [facing]\n`;
                                    break;
                                }

                                // check if the length is outbound or not
                                if (
                                    x < 0 ||
                                    x >= Number(loadedLevel.x) ||
                                    y < 0 ||
                                    y >= Number(loadedLevel.y)
                                ) {
                                    textarea.value += `Coordinates must be inside the level. Usage: place belt x y [facing]\n`;
                                    break;
                                }

                                // ensure the direction exist
                                if (
                                    ["up", "down", "left", "right"].includes(
                                        facing,
                                    )
                                ) {
                                    var beltObj = new objBelt(x, y, facing);
                                } else if (facing.length === 0) {
                                    var beltObj = new objBelt(x, y, "down");
                                } else {
                                    textarea.value += `Failed to place Belt: Invalid direction.`;
                                    break;
                                }

                                // put the obj into game
                                if (
                                    placeObjects(
                                        document.querySelector("#gameTable"),
                                        beltObj,
                                        "add",
                                    )
                                ) {
                                    textarea.value += `Belt(${beltObj.direction}) placed at (${x}, ${y})\n`;
                                } else {
                                    textarea.value += `Failed to place Belt(${beltObj.direction}) at (${x}, ${y})\n`;
                                }

                                break;
                        }
                        break;
                    case "run":
                        // so we need some way to display on top of the "table" board
                        // idk if its a good idea but we need to put a relative positioned "Robot" (or chess)
                        // to move on the table (or grid), that can be smooth and not replacing the tile/obj
                        runRobot();
                        break;
                    default:
                        textarea.value +=
                            "Unknown command. Try to use 'help' to get the command list.\n";
                }

                textarea.scrollTop = textarea.scrollHeight;
            }
        </script>
    </body>
</html>
